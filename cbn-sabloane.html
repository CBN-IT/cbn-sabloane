<link rel="import" href="../polymer/polymer.html">


<link rel="import" href="../cbn-ace-editor/cbn-ace-editor.html">
<link rel="import" href="../cbn-form/cbn-form.html">
<link rel="import" href="../cbn-form/elements/polymer-elements.html">
<link rel="import" href="../cbn-form/cbn-dynamic-form.html">
<link rel="import" href="../cbn-select/cbn-paper-select.html">
<link rel="import" href="../cbn-grid/cbn-grid.html">


<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../iron-behaviors/iron-control-state.html">


<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../cbn-tooltip/cbn-tooltip.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">



<!--
`cbn-sabloane` 

    <cbn-sabloane></cbn-sabloane>

### Validation

### Styling

@demo demo/index.html
@class cbn-sabloane
-->

<dom-module id="cbn-sabloane">
	<template>
		<style>
			:host {
				@apply(--layout-vertical);
			}
			.form cbn-paper-select,
			.form paper-input,
			.form cbn-paper-datepicker{
				padding:0px 10px;
			}
			.form paper-input-container{
				padding: 4px 0;
			}
			iron-pages{
				@apply(--layout-vertical);
				@apply(--layout-flex);
			}
			section {
				@apply(--layout-flex);
			}
			cbn-ace-editor {
				margin: 0
			}
			:host {
				outline:none;
			}
			.save{
				background: #4285f4;
				color: #fff;
				min-width: 0;
				padding: 0 15px 0 10px;
				margin: 0;
				height: 30px;
				overflow: hidden;
			}
			.save > .save-icon {
				width: 24px;
				height: 24px;
				margin: 3px 0;
			}
			.save > .save-spinner{
				--paper-spinner-layer-1-color: white;
				--paper-spinner-layer-2-color: white;
				--paper-spinner-layer-3-color: white;
				--paper-spinner-layer-4-color: white;
				--paper-spinner-color: white;
				height: 20px;
				width: 20px;
				margin: 5px 2px;
			}
		</style>
		<style include="cbn-grid-shared-style"></style>
		<iron-a11y-keys keys="ctrl+s" target="[[_target]]" on-keys-pressed="saveSablon" stop-keyboard-event-propagation="true"></iron-a11y-keys>
		<paper-tabs selected="{{tab}}" >
			<paper-tab>Configurare</paper-tab>
			<paper-tab>Cod sablon</paper-tab>
			<paper-tab>Nume Fisier</paper-tab>
			<paper-tab>Import</paper-tab>
		</paper-tabs>
		<iron-pages selected="{{tab}}">
			<section>
				<form is="cbn-form" action="/salveaza/SalveazaSablon" handleAs="json" model="{{model}}" params="{{params}}" id="formSablon" method="post" on-cbn-form-response="sablonSaved">
					<cbn-dynamic-form config="{{_configSablon}}"></cbn-dynamic-form>
					<paper-button class="save" on-tap="saveSablon">
						<iron-icon class="save-icon" icon="check" hidden$="[[loading]]"></iron-icon>
						<paper-spinner-lite class="save-spinner" active="[[loading]]" hidden$="[[!loading]]"></paper-spinner-lite>
						<span class="save-text">Salveaza</span>
						<cbn-tooltip position="right" class="tooltip" animation-delay="0">Salveaza (CTRL+S)</cbn-tooltip>
					</paper-button>
					
				</form>
			</section>
			<section style="position:relative">
				<cbn-ace-editor id="contentSablon"  mode="xml" theme="crimson_editor" font-size="1em" value="{{model.contentSablon}}"></cbn-ace-editor>
			</section>
			<section style="position:relative">
				<cbn-ace-editor id="numeFisier"  mode="xml" theme="crimson_editor" font-size="1em" value="{{model.numeFisier}}"></cbn-ace-editor>
			</section>
			<section>
				&lt;import data-adma-import="<span>{{model._hash}}</span>"&gt;<br />
					<span>{{model.numeSablon}}</span><br />
					<span>{{model.entitate}}</span><br />
					Multiplicare procese: <span>{{model.multiplicareProcese}}</span><br />
					AplicÄƒ:  <span>{{model.aplicare}}</span><br />
					<span>{{model.description}}</span><br />
				&lt;/import&gt;
			</section>
		</iron-pages>
	</template>
</dom-module>

<script>
	(function () {
		Polymer({

			is: 'cbn-sabloane',
			behaviors: [Polymer.IronControlState],
			properties: {
				params: {
					type:Object,
					value: function(){
						return {}
					}
				},
				/**
				 * The list of kinds to appear in the Entitate Dropdown
				 */
				kinds: {
					type: Array,
					value: function () {
						return [];
					},
					notify: false,
					readOnly: false,
					reflectToAttribute: false
				},
				/**
				 * The tab that is currently active
				 */
				tab: {
					type: Number,
					value: 0,
					notify: true,
					readOnly: false,
					reflectToAttribute: false,
					observer:"_tabChanged"
				},
				/**
				 * The form config needed for the dinamic form
				 */
				_configSablon: {
					type: Object,
					value: function () {
						return {};
					},
					notify: false,
					reflectToAttribute: false
				},

				/**
				 * 
				 */
				model: {
					type: Object,
					value: function () {
						return {
							multiplicareProcese: "Nu",
							aplicare: "Manual"
						};
					},
					notify: true,
					readOnly: false,
					reflectToAttribute: false,
					observer: "_modelChanged"
				},
				/**
				 * if you still have ajax in progress
				 */
				loading: {
					type: Boolean,
					value: false,
					notify: true,
					readOnly: false,
					reflectToAttribute: false
				},

				/**
				 * 
				 */
				_target: {
					type: Object,
					value: function () {
						return this;
					},
					notify: false,
					readOnly: false,
					reflectToAttribute: false
				}

			},
			hostAttributes:{
				tabindex: "1"
			},
			observers: [],
			ready: function () {
				this._setConfigSablon();
				this.reset();
			},
			reset: function () {
				this.model = {
					multiplicareProcese: "Nu",
					aplicare: "Manual"
				};
			},
			_setConfigSablon: function(){
				this._configSablon = {
					"elements": [
						{
							"label": "Nume Sablon",
							"type": "text",
							"element": "paper-input",
							"name": "numeSablon",
							"format": "",
							"dbType": "string",
							"defaultValue": "",
							"info": "",
							"search": false,
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"number": {
									"validate": false,
									"type": ""
								},
								"unique": false,
								"email": false,
								"cnp": false,
								"cif": false,
								"minLength": "",
								"maxLength": "",
								"min": "",
								"max": ""
							},
							"autoValidate": true,
							"decorator": "cbn-input-decorator",
							"floatingLabel": true
						},
						{
							"type": "select",
							"element": "cbn-paper-select",
							"label": "Tip Generare",
							"name": "tipGenerare",
							"search": false,
							"multiple": false,
							"info": "",
							"database": "",
							"property": "",
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"minLength": "",
								"maxLength": ""
							},
							"preview": true,
							"autoValidate": true,
							itemValueProperty: "value",
							"options": [
								{label: "Word", value: "word"},
								{label: "Excel (xls)", value: "excel"},
								{label: "PDF", value: "pdf"},
								{label: "XML", value: "xml"},
								{label: "Img", value: "img"},
								{label: "Email", value: "email"},
								{label: "Formula", value: "formula"},
								{label: "Dashboard", value: "dashboard"}
							],
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						},
						{
							"type": "select",
							"element": "cbn-paper-select",
							"label": "Multiplicare Procese",
							"name": "multiplicareProcese",
							"search": false,
							"multiple": false,
							"info": "",
							"database": "",
							"property": "",
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"minLength": "",
								"maxLength": ""
							},
							"autoValidate": true,
							"options": [
								"Nu",
								"Da"
							],
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						},
						{
							"type": "select",
							"element": "cbn-paper-select",
							"label": "Entitate",
							"name": "entitate",
							"search": false,
							"multiple": false,
							"info": "",
							"database": "",
							"property": "",
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"minLength": "",
								"maxLength": ""
							},
							"preview": true,
							"autoValidate": true,
							itemValueProperty: "value",
							"options": this.kinds,
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						},
						{
							"type": "select",
							"element": "cbn-paper-select",
							"label": "Aplica",
							"name": "aplicare",
							"search": false,
							"multiple": false,
							"info": "",
							"database": "",
							"property": "",
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"minLength": "",
								"maxLength": ""
							},
							"autoValidate": true,
							"options": [
								"Manual",
								"Automat"
							],
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						},
						{
							"type": "textarea",
							"element": "paper-input",
							"label": "Descriere",
							"name": "description",
							"search": false,
							"multiple": false,
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": false,
								"minLength": "",
								"maxLength": ""
							},
							"autoValidate": true,
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						}
					]
				};
			},
			_tabChanged: function(){
				if (this.tab === 1) {
					/*
					this is here because if the editor is not visible it doesn't update the content of the editor until you click inside it
					we want to update only on model changed, cause that is the only time it comes from outside. 
					when you change between tabs, it was resetting the cursor position
					*/
					if (this.refreshContentSablon) {
						this.$.contentSablon._valueChanged();
						this.refreshContentSablon = false;
					}
					this.$.contentSablon.focus();
				} 
				if (this.tab === 2) {
					if (this.refreshNumeFisier) {
						this.$.numeFisier._valueChanged();
						this.refreshNumeFisier = false;
					}
					this.$.numeFisier.focus();
				}
			},
			_modelChanged: function () {
				this.tab = 0;
				this.refreshContentSablon = true;
				this.refreshNumeFisier = true;
			},
			saveSablon: function (event) {
				/*not to show the download html thing when ctrl+s is pressed
				 the button doesn't throw the keyboardEvent thing;*/
				if (event.detail.keyboardEvent != null) {
					event.detail.keyboardEvent.preventDefault();
				}
				this.model.contentSablon = this.$.contentSablon.editorValue;
				this.model.numeFisier = this.$.numeFisier.editorValue;
				if (!this.$.formSablon.validate()) {
					this.tab = 0;
				}
				this.$.formSablon.submit();
			},
			sablonSaved: function(event){
				/*after save we set the hash back into the model so the second save does an update instead of a new save*/
				this.model._hash = event.detail.response._hash;
			}
		})
	})();
</script>
