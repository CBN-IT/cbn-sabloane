<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../iron-behaviors/iron-control-state.html">

<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">

<link rel="import" href="../cbn-tooltip/cbn-tooltip.html">
<link rel="import" href="../cbn-ace-editor/cbn-ace-editor.html">

<link rel="import" href="../cbn-main-page/cbn-page-behavior.html">
<link rel="import" href="../cbn-main-page/import-form-elements.html">

<dom-module id="cbn-adauga-sablon">
	<template>
		<style>
			:host {
				@apply(--layout-vertical);
				background-color: white;
			}
			/*<editor-fold desc="paper-tabs" defaultstate="collapsed">*/
			:host {
				--paper-tabs-selection-bar-color: var(--google-blue-500);
				--paper-tab-ink: var(--google-blue-500);
			}

			/*</editor-fold>*/
			iron-pages{
				@apply(--layout-vertical);
				@apply(--layout-flex);
			}
			section {
				@apply(--layout-flex);
			}
			cbn-ace-editor {
				margin: 0
			}
			:host {
				outline:none;
			}
			.save{
				background: #4285f4;
				color: #fff;
				min-width: 0;
				padding: 0 15px 0 10px;
				margin: 0;
				height: 30px;
				overflow: hidden;
			}
			.save > .save-icon {
				width: 24px;
				height: 24px;
				margin: 3px 0;
			}
			.save > .save-spinner{
				--paper-spinner-layer-1-color: white;
				--paper-spinner-layer-2-color: white;
				--paper-spinner-layer-3-color: white;
				--paper-spinner-layer-4-color: white;
				--paper-spinner-color: white;
				height: 20px;
				width: 20px;
				margin: 5px 2px;
			}
		</style>
		<style include="cbn-grid-shared-style"></style>
		<style include="cbn-form-shared-style"></style>
		
		<iron-a11y-keys keys="ctrl+s" target="[[_self]]" on-keys-pressed="saveSablon" stop-keyboard-event-propagation="true"></iron-a11y-keys>
		<paper-tabs selected="{{tab}}" >
			<paper-tab>Configurare</paper-tab>
			<paper-tab>Cod sablon</paper-tab>
			<paper-tab>Nume Fisier</paper-tab>
			<paper-tab>Import</paper-tab>
		</paper-tabs>
		<iron-pages selected="{{tab}}">
			<section>
				<form is="cbn-form" action="/salveaza/SalveazaSablon" handleAs="json" model="{{currentModel}}" params='{{params}}' id="formSablon" method="post" on-cbn-form-response="sablonSaved">
					<cbn-dynamic-form config="{{_configSablon}}"></cbn-dynamic-form>
					<paper-button class="save" on-tap="saveSablon" style="margin: 10px 0 0 10px;">
						<iron-icon class="save-icon" icon="check" hidden$="[[loading]]"></iron-icon>
						<paper-spinner-lite class="save-spinner" active="[[loading]]" hidden$="[[!loading]]"></paper-spinner-lite>
						<span class="save-text">Salveaza</span>
						<cbn-tooltip position="right" class="tooltip" animation-delay="0">Salveaza (CTRL+S)</cbn-tooltip>
					</paper-button>
				</form>
			</section>
			<section style="position:relative">
				<cbn-ace-editor id="contentSablon"  mode="xml" theme="crimson_editor" font-size="1em" value="{{currentModel.contentSablon}}"></cbn-ace-editor>
			</section>
			<section style="position:relative">
				<cbn-ace-editor id="numeFisier"  mode="xml" theme="crimson_editor" font-size="1em" value="{{currentModel.numeFisier}}"></cbn-ace-editor>
			</section>
			<section>
				&lt;import data-adma-import="<span>{{currentModel._hash}}</span>"&gt;<br />
					<span>{{currentModel.numeSablon}}</span><br />
					<span>{{currentModel.entitate}}</span><br />
					Multiplicare procese: <span>{{currentModel.multiplicareProcese}}</span><br />
					AplicÄƒ:  <span>{{currentModel.aplicare}}</span><br />
					<span>{{currentModel.description}}</span><br />
				&lt;/import&gt;
			</section>
		</iron-pages>
	</template>
</dom-module>

<script>
	(function () {
		Polymer({

			is: 'cbn-adauga-sablon',
			behaviors: [
				Cbn.facturi.pageBehavior,
				Polymer.IronControlState
			],
			properties: {
				dataRoute: {
					type: String,
					reflectToAttribute: true,
					value: "/sablon/adauga"
				},
				type: {
					type: String,
					value: "sablon"
				},
				params: {
					type:Object,
					value: function(){
						return {}
					}
				},
				/**
				 * The list of kinds to appear in the Entitate Dropdown
				 */
				kinds: {
					type: Array,
					value: function () {
						return [];
					},
					notify: false,
					readOnly: false,
					reflectToAttribute: false
				},
				/**
				 * The tab that is currently active
				 */
				tab: {
					type: Number,
					value: 0,
					notify: true,
					readOnly: false,
					reflectToAttribute: false,
					observer:"_tabChanged"
				},
				/**
				 * The form config needed for the dinamic form
				 */
				_configSablon: {
					type: Object,
					value: function () {
						return {};
					},
					notify: false,
					reflectToAttribute: false
				},

				currentModel: {
					type: Object,
					value: function () {
						return {
							multiplicareProcese: "Nu",
							aplicare: "Manual"
						};
					},
					notify: true,
					readOnly: false,
					reflectToAttribute: false,
					observer: "_modelChanged"
				},
				loading: {
					type: Boolean,
					value: false,
					notify: true,
					readOnly: false,
					reflectToAttribute: false
				},
				_self: {
					type: Object,
					value: function () {
						return this;
					},
					notify: false,
					readOnly: false,
					reflectToAttribute: false
				}

			},
			hostAttributes:{
				tabindex: "1"
			},
			observers: [],
			ready: function () {
				page('/'+this.type+'/adauga', function (cx, next) {
					this.currentModel = {};
					app.route = this.dataRoute;
					app.routeSection = this.dataRoute;
					cx.handled = true;
					next();
				}.bind(this));

				page('/'+this.type+'/editeaza/:hash', function (cx, next) {
					this.require(this.type, function () {
						this.editeaza.apply(this, [cx, next]);
					}.bind(this));
				}.bind(this));
				
				
				
				this._setConfigSablon();
				this.reset();
			},
			editeaza: function(cx, next){
				var hash = cx.params.hash;
				var currentModel = {};
				this.listEntities.forEach(function(itm){
					if(itm._hash === hash){
						model = itm;
					}
				});
				this.currentModel = model;
				app.route = this.dataRoute;
				app.routeSection = this.dataRoute;
				cx.handled = true;
				next();
			},
			reset: function () {
				this.currentModel = {
					multiplicareProcese: "Nu",
					aplicare: "Manual"
				};
			},
			_tabChanged: function(){
				if (this.tab === 1) {
					/*
					this is here because if the editor is not visible it doesn't update the content of the editor until you click inside it
					we want to update only on model changed, cause that is the only time it comes from outside. 
					when you change between tabs, it was resetting the cursor position
					*/
					if (this.refreshContentSablon) {
						this.$.contentSablon._valueChanged();
						this.refreshContentSablon = false;
					}
					this.$.contentSablon.focus();
				} 
				if (this.tab === 2) {
					if (this.refreshNumeFisier) {
						this.$.numeFisier._valueChanged();
						this.refreshNumeFisier = false;
					}
					this.$.numeFisier.focus();
				}
			},
			_modelChanged: function () {
				this.tab = 0;
				this.refreshContentSablon = true;
				this.refreshNumeFisier = true;
			},
			saveSablon: function (event) {
				/*not to show the download html thing when ctrl+s is pressed
				 the button doesn't throw the keyboardEvent thing;*/
				if (event.detail.keyboardEvent != null) {
					event.detail.keyboardEvent.preventDefault();
				}
				this.currentModel.contentSablon = this.$.contentSablon.editorValue;
				this.currentModel.numeFisier = this.$.numeFisier.editorValue;
				if (!this.$.formSablon.validate()) {
					this.tab = 0;
				}
				this.$.formSablon.submit();
			},
			sablonSaved: function(event){
				/*after save we set the hash back into the model so the second save does an update instead of a new save*/
				this.currentModel._hash = event.detail.response._hash;
			},
			_setConfigSablon: function(){
				this._configSablon = {
					"elements": [
						{
							"label": "Nume Sablon",
							"type": "text",
							"element": "paper-input",
							"name": "numeSablon",
							"format": "",
							"dbType": "string",
							"defaultValue": "",
							"info": "",
							"search": false,
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"number": {
									"validate": false,
									"type": ""
								},
								"unique": false,
								"email": false,
								"cnp": false,
								"cif": false,
								"minLength": "",
								"maxLength": "",
								"min": "",
								"max": ""
							},
							"autoValidate": true,
							"decorator": "cbn-input-decorator",
							"floatingLabel": true
						},
						{
							"type": "select",
							"element": "cbn-paper-select",
							"label": "Tip Generare",
							"name": "tipGenerare",
							"search": false,
							"multiple": false,
							"info": "",
							"database": "",
							"property": "",
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"minLength": "",
								"maxLength": ""
							},
							"preview": true,
							"autoValidate": true,
							itemValueProperty: "value",
							"options": [
								{label: "Word", value: "word"},
								{label: "Excel (xls)", value: "excel"},
								{label: "PDF", value: "pdf"},
								{label: "XML", value: "xml"},
								{label: "Img", value: "img"},
								{label: "Email", value: "email"},
								{label: "Formula", value: "formula"},
								{label: "Dashboard", value: "dashboard"}
							],
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						},
						{
							"type": "select",
							"element": "cbn-paper-select",
							"label": "Multiplicare Procese",
							"name": "multiplicareProcese",
							"search": false,
							"multiple": false,
							"info": "",
							"database": "",
							"property": "",
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"minLength": "",
								"maxLength": ""
							},
							"autoValidate": true,
							"options": [
								"Nu",
								"Da"
							],
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						},
						{
							"type": "select",
							"element": "cbn-paper-select",
							"label": "Entitate",
							"name": "entitate",
							"search": false,
							"multiple": false,
							"info": "",
							"database": "",
							"property": "",
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"minLength": "",
								"maxLength": ""
							},
							"preview": true,
							"autoValidate": true,
							itemValueProperty: "value",
							"options": this.kinds,
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						},
						{
							"type": "select",
							"element": "cbn-paper-select",
							"label": "Aplica",
							"name": "aplicare",
							"search": false,
							"multiple": false,
							"info": "",
							"database": "",
							"property": "",
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": true,
								"minLength": "",
								"maxLength": ""
							},
							"autoValidate": true,
							"options": [
								"Manual",
								"Automat"
							],
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						},
						{
							"type": "textarea",
							"element": "paper-input",
							"label": "Descriere",
							"name": "description",
							"search": false,
							"multiple": false,
							"className": "col-xs-12 col-sm-12 col-lg-12",
							"validation": {
								"required": false,
								"minLength": "",
								"maxLength": ""
							},
							"autoValidate": true,
							"decorator": "cbn-input-decorator",
							"floatingLabel": true,
							"alwaysShowChips": true
						}
					]
				};
			}
		})
	})();
</script>
